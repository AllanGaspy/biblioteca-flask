{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Registrar Empréstimo</h2>

  <!-- Mensagens Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="form-cadastrar-emprestimo">
    <div class="mb-3">
      <label class="form-label">Data de Retirada</label>
      <input type="date" name="data_retirada" id="data_retirada" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Data Prevista de Devolução</label>
      <input type="date" name="data_prevista_devolucao" id="data_prevista" class="form-control" required>
    </div>

    <!-- Campo de usuário com datalist -->
    <div class="mb-3">
      <label class="form-label">Usuário</label>
      <input list="listaUsuarios" id="usuario_input" class="form-control" placeholder="Digite o nome do usuário" required>
      <datalist id="listaUsuarios">
        {% for u in usuarios %}
        <option data-id="{{ u.id_usuario }}" value="{{ u.nome }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_usuario" id="id_usuario">
    </div>

    <!-- Campo de livro com datalist -->
    <div class="mb-3">
      <label class="form-label">Livro</label>
      <input list="listaLivros" id="livro_input" class="form-control" placeholder="Digite o título do livro" required>
      <datalist id="listaLivros">
        {% for l in livros %}
        <option data-id="{{ l.id_livro }}" value="{{ l.titulo }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_livro" id="id_livro">
    </div>

    <button type="submit" class="btn btn-success">Salvar</button>
    <a href="{{ url_for('emprestimo.listar') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
  // Preencher campo oculto com ID do usuário
  document.getElementById('usuario_input').addEventListener('input', function () {
    const val = this.value;
    const opt = [...document.getElementById('listaUsuarios').options].find(o => o.value === val);
    document.getElementById('id_usuario').value = opt ? opt.dataset.id : '';
  });

  // Preencher campo oculto com ID do livro
  document.getElementById('livro_input').addEventListener('input', function () {
    const val = this.value;
    const opt = [...document.getElementById('listaLivros').options].find(o => o.value === val);
    document.getElementById('id_livro').value = opt ? opt.dataset.id : '';
  });

  // Validação de datas
  document.getElementById('form-cadastrar-emprestimo').addEventListener('submit', function (e) {
    const dataRetirada = new Date(document.getElementById('data_retirada').value);
    const dataPrevista = new Date(document.getElementById('data_prevista').value);
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    if (dataRetirada > hoje) {
      alert("A data de retirada não pode ser maior que hoje.");
      e.preventDefault();
      return;
    }

    if (dataPrevista < dataRetirada) {
      alert("A data prevista de devolução não pode ser menor que a data de retirada.");
      e.preventDefault();
    }
  });
</script>
{% endblock %}
