{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Registrar Empr√©stimo</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="form-cadastrar-emprestimo">
    <div class="mb-3">
      <label class="form-label">Data de Retirada</label>
      <input type="date" name="data_retirada" id="data_retirada" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Data Prevista de Devolu√ß√£o</label>
      <input type="date" name="data_prevista_devolucao" id="data_prevista" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Usu√°rio</label>
      <input list="listaUsuarios" id="usuario_input" class="form-control" placeholder="Digite o nome do usu√°rio" required>
      <datalist id="listaUsuarios">
        {% for u in usuarios %}
        <option data-id="{{ u.id_usuario }}" value="{{ u.nome }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_usuario" id="id_usuario">
    </div>

    <div class="mb-3">
      <label class="form-label">Livro</label>
      <input list="listaLivros" id="livro_input" class="form-control" placeholder="Digite o t√≠tulo do livro" required>
      <datalist id="listaLivros">
        {% for l in livros %}
        <option data-id="{{ l.id_livro }}" value="{{ l.titulo }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_livro" id="id_livro">
      <small id="info_copias" class="form-text text-muted mt-1">
        üìö C√≥pias dispon√≠veis: <span id="copias_text">Selecione um livro</span>
      </small>
    </div>

    <button type="submit" class="btn btn-success">Salvar</button>
    <a href="{{ url_for('emprestimo.listar') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
  const inputUsuario = document.getElementById('usuario_input');
  const inputLivro = document.getElementById('livro_input');
  const datalistUsuarios = document.getElementById('listaUsuarios');
  const datalistLivros = document.getElementById('listaLivros');
  const campoIdUsuario = document.getElementById('id_usuario');
  const campoIdLivro = document.getElementById('id_livro');
  const textoCopias = document.getElementById('copias_text');

  inputUsuario.addEventListener('input', function () {
    const val = this.value;
    const opt = [...datalistUsuarios.options].find(o => o.value === val);
    campoIdUsuario.value = opt ? opt.dataset.id : '';
  });

  inputLivro.addEventListener('input', function () {
    const val = this.value;
    const opt = [...datalistLivros.options].find(o => o.value === val);
    const idLivro = opt ? opt.dataset.id : '';
    campoIdLivro.value = idLivro;

    if (idLivro) {
      fetch(`/emprestimos/verificar-copias/${idLivro}`)
        .then(res => res.json())
        .then(data => {
          textoCopias.textContent = data.num_copias_disponiveis;
        })
        .catch(() => {
          textoCopias.textContent = 'Erro ao verificar';
        });
    } else {
      textoCopias.textContent = 'Selecione um livro';
    }
  });

  document.getElementById('form-cadastrar-emprestimo').addEventListener('submit', function (e) {
    const dataRetirada = new Date(document.getElementById('data_retirada').value);
    const dataPrevista = new Date(document.getElementById('data_prevista').value);
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    if (dataRetirada > hoje) {
      alert("A data de retirada n√£o pode ser maior que hoje.");
      e.preventDefault();
      return;
    }

    if (dataPrevista < dataRetirada) {
      alert("A data prevista de devolu√ß√£o n√£o pode ser menor que a data de retirada.");
      e.preventDefault();
      return;
    }

    const copiasDisponiveis = parseInt(textoCopias.textContent);
    if (isNaN(copiasDisponiveis) || copiasDisponiveis <= 0) {
      alert("N√£o √© poss√≠vel realizar empr√©stimo: sem c√≥pias dispon√≠veis do livro.");
      e.preventDefault();
    }
  });
</script>
{% endblock %}
