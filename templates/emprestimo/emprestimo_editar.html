{% extends 'base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="container mt-4">
  <h2>Editar Empréstimo</h2>
  <form method="POST" id="form-editar-emprestimo">
    <div class="mb-3">
      <label class="form-label">Data de Retirada</label>
      <input type="date" name="data_retirada" id="data_retirada" class="form-control" value="{{ emprestimo.data_retirada }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Data Prevista de Devolução</label>
      <input type="date" name="data_prevista_devolucao" id="data_prevista" class="form-control" value="{{ emprestimo.data_prevista_devolucao }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Data Real de Devolução</label>
      <input type="date" name="data_real_devolucao" id="data_real" class="form-control" value="{{ emprestimo.data_real_devolucao }}">
    </div>

    <!-- Usuário com datalist -->
    <div class="mb-3">
      <label class="form-label">Usuário</label>
      <input list="listaUsuarios" id="usuario_input" class="form-control" placeholder="Digite o nome do usuário" value="{{ emprestimo.nome_usuario }}" required>
      <datalist id="listaUsuarios">
        {% for u in usuarios %}
        <option data-id="{{ u.id_usuario }}" value="{{ u.nome }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_usuario" id="id_usuario" value="{{ emprestimo.fk_Usuario_id_usuario }}">
    </div>

    <!-- Livro com datalist -->
    <div class="mb-3">
      <label class="form-label">Livro</label>
      <input list="listaLivros" id="livro_input" class="form-control" placeholder="Digite o título do livro" value="{{ emprestimo.titulo_livro }}" required>
      <datalist id="listaLivros">
        {% for l in livros %}
        <option data-id="{{ l.id_livro }}" value="{{ l.titulo }}"></option>
        {% endfor %}
      </datalist>
      <input type="hidden" name="id_livro" id="id_livro" value="{{ emprestimo.fk_Livro_id_livro }}">
    </div>

    <button type="submit" class="btn btn-primary">Salvar</button>
    <a href="{{ url_for('emprestimo.listar') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
  document.getElementById('usuario_input').addEventListener('input', function () {
    const val = this.value;
    const opt = [...document.getElementById('listaUsuarios').options].find(o => o.value === val);
    if (opt) {
      document.getElementById('id_usuario').value = opt.dataset.id;
    }
  });

  document.getElementById('livro_input').addEventListener('input', function () {
    const val = this.value;
    const opt = [...document.getElementById('listaLivros').options].find(o => o.value === val);
    if (opt) {
      document.getElementById('id_livro').value = opt.dataset.id;
    }
  });

  document.getElementById('form-editar-emprestimo').addEventListener('submit', function (e) {
    const dataRetirada = new Date(document.getElementById('data_retirada').value);
    const dataPrevista = new Date(document.getElementById('data_prevista').value);
    const dataRealInput = document.getElementById('data_real').value;
    const dataReal = dataRealInput ? new Date(dataRealInput) : null;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    if (dataRetirada > hoje) {
      alert("A data de retirada não pode ser maior que hoje.");
      e.preventDefault();
      return;
    }

    if (dataPrevista < dataRetirada) {
      alert("A data prevista de devolução não pode ser menor que a data de retirada.");
      e.preventDefault();
      return;
    }

    if (dataReal && dataReal < dataRetirada) {
      alert("A data real de devolução não pode ser menor que a data de retirada.");
      e.preventDefault();
    }
  });
</script>
{% endblock %}
